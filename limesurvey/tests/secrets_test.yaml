suite: Test Secrets Manifest
templates:
  - secrets.yaml
tests:
  - it: secrets with external database
    release:
      name: my-ls
    set:
      ### Helm values
      limesurvey:
        admin:
          password: foobar123
      externalDatabase:
        password: barbaz456
      ###
    asserts:
      - hasDocuments:
          count: 2
      ### Check app secrets
      - isKind:
          of: Secret
        documentIndex: 0
      - equal:
          path: metadata.name
          value: my-ls-limesurvey-app-secrets
        documentIndex: 0
      - matchRegex:
          path: data.limesurvey-admin-password
          pattern: 'Zm9vYmFyMTIz' # I think helm-unittest has a bit of a parsing failure
        documentIndex: 0

      ### Check db secrets
      - isKind:
          of: Secret
        documentIndex: 1
      - equal:
          path: data.db-password
          value: 'YmFyYmF6NDU2' # I think helm-unittest has a bit of a parsing failure
        documentIndex: 1

  - it: secrets with embedded mariadb
    release:
      name: my-ls
    set:
      ### Helm values
      mariadb:
        enabled: true
      ###
    asserts:
      # In this case there should only be one secret created by us
      - hasDocuments:
          count: 1
      ### Check app secrets
      - isKind:
          of: Secret
        documentIndex: 0
      - equal:
          path: metadata.name
          value: my-ls-limesurvey-app-secrets
        documentIndex: 0
